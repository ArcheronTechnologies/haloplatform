name: Check for Sensitive Data

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  scan-secrets:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for secret scanning

    - name: Check for data source leaks
      run: |
        echo "Scanning for sensitive data source information..."

        # Patterns that should NOT be in the repository
        SENSITIVE_PATTERNS=(
          "uyMBu2LtKfiY"                    # SCB cert password
          "AnQ27kXW8z4sdOMJHJuFJGf5AFIa"    # Bolagsverket client ID
          "L4bi0Wh_pDiMZ7GrKb9PYd1274oa"    # Bolagsverket secret
          "privateapi\.scb\.se"              # Private SCB API
          "scb_cert\.pfx"                    # Certificate file reference
        )

        FOUND=0

        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
          echo "Checking for pattern: $pattern"
          if git grep -n "$pattern" -- ':!*.local.*' ':!.data_sources_local/' ':!Data_credentials.md'; then
            echo "❌ FOUND sensitive pattern: $pattern"
            FOUND=1
          fi
        done

        if [ $FOUND -eq 1 ]; then
          echo ""
          echo "=========================================="
          echo "❌ SENSITIVE DATA DETECTED"
          echo "=========================================="
          echo ""
          echo "Sensitive data source information found in repository."
          echo "This should be redacted before committing."
          echo ""
          echo "Run: ./scripts/redact_data_sources.sh"
          echo ""
          exit 1
        fi

        echo "✅ No sensitive patterns detected"

    - name: Check for .local files
      run: |
        echo "Checking for accidentally committed .local files..."

        if git ls-files | grep '\.local\.'; then
          echo "❌ Found .local files in repository"
          echo "These should be in .gitignore"
          exit 1
        fi

        echo "✅ No .local files found"

    - name: Check for credentials in env files
      run: |
        echo "Checking for credentials in environment files..."

        # Check if any .env files (except .env.example) are committed
        if git ls-files | grep -E '^\.env$|^\.env\.'; then
          echo "❌ Found .env files in repository"
          echo "Only .env.example should be committed"
          exit 1
        fi

        echo "✅ No .env files found"

    - name: Verify redaction notices
      run: |
        echo "Verifying redacted files have redaction notices..."

        REDACTED_FILES=(
          "src/halo/ingestion/API_COMPLIANCE.md"
          "src/halo/ingestion/SCB_DATA_PLAN.md"
          "docs/api_findings.md"
        )

        for file in "${REDACTED_FILES[@]}"; do
          if [ -f "$file" ]; then
            if ! head -5 "$file" | grep -q "REDACTED VERSION FOR PUBLIC REPOSITORY"; then
              echo "⚠️  File missing redaction notice: $file"
              echo "   Run: ./scripts/redact_data_sources.sh"
            else
              echo "✅ Redaction notice found: $file"
            fi
          fi
        done

    - name: Summary
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "✅ ALL SECURITY CHECKS PASSED"
        echo "=========================================="
        echo ""
        echo "Repository is clean of sensitive data source information."
        echo ""
